"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("util"),e=require("mongodb"),n=require("debug"),o=require("object-assign"),i=require("events");function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=r(e),c=r(n),a=r(o);class u{constructor(t,e,n){var o;this.manager=t,this.name=e,this.options=n,this.middlewares=this.options.middlewares||[],delete this.options.middlewares,this._dispatch=(o=this.middlewares,function(t,e){var n,i={monkInstance:t,collection:e};return 0===(n=o.map((function(t){return t(i)}))).length?function(t){return t}:1===n.length?n[0]:n.reduce((function(t,e){return function(n){return t(e(n))}}))})(t,this)}bulkWrite(t,e,n){return"function"==typeof e&&(n=e,e={}),this._dispatch((t=>t.col.bulkWrite(t.operations,t.options)))({options:e,operations:t,callback:n},"bulkWrite")}ensureIndex(t,e,n){throw new Error("REMOVED (collection.ensureIndex): use collection.createIndex instead (see https://Automattic.github.io/monk/docs/collection/createIndex.html)")}geoHaystackSearch(t,e,n,o){throw new Error("geoHaystackSearch command is not supported anymore (see https://docs.mongodb.com/manual/reference/command/geoHaystackSearch)")}geoNear(){throw new Error("geoNear command is not supported anymore (see https://docs.mongodb.com/manual/reference/command/geoNear)")}group(t,e,n,o,i,r,s,c){"function"==typeof s&&(c=s,s={});let a=new Error("DEPRECATED (collection.group): MongoDB 3.6 or higher no longer supports the group command. We recommend rewriting using the aggregation framework.");return console.warn(a),this._dispatch((t=>t.col.group(t.keys,t.condition,t.initial,t.reduce,t.finalize,t.command,t.options)))({options:s,keys:t,condition:e,initial:n,reduce:o,finalize:i,command:r,callback:c},"group")}mapReduce(t,e,n,o){return this._dispatch((t=>t.col.mapReduce(t.map,t.reduce,t.options)))({map:t,reduce:e,options:n,callback:o},"mapReduce")}stats(t,e){return"function"==typeof t&&(e=t,t={}),this._dispatch((function(t){return t.col.stats(t.options)}))({options:t,callback:e},"stats")}aggregate(t,e,n){return"function"==typeof e&&(n=e,e={}),this._dispatch((function(t){return t.col.aggregate(t.stages,t.options).toArray()}))({options:e,stages:t,callback:n},"aggregate")}count(t,e,n){return"function"==typeof e&&(n=e,e={}),"function"==typeof t&&(n=t,t={}),this._dispatch((function(t){const{estimate:e,...n}=t.options;return e?t.col.estimatedDocumentCount(n):t.col.countDocuments(t.query,n)}))({options:e,query:t,callback:n},"count")}createIndex(t,e,n){return"function"==typeof e&&(n=e,e={}),this._dispatch((function(t){return t.col.createIndex(t.fields,t.options)}))({options:e,fields:t,callback:n},"createIndex")}distinct(t,e,n,o){return"function"==typeof n&&(o=n,n={}),"function"==typeof e&&(o=e,e={}),this._dispatch((function(t){return t.col.distinct(t.field,t.query,t.options)}))({options:n,query:e,field:t,callback:o},"distinct")}drop(t){return this._dispatch((function(t){return t.col.drop().catch((function(t){if(t&&"ns not found"===t.message)return"ns not found";throw t}))}))({callback:t},"drop")}dropIndex(t,e,n){return"function"==typeof e&&(n=e,e={}),this._dispatch((function(t){return t.col.dropIndex(t.fields,t.options)}))({options:e,fields:t,callback:n},"dropIndex")}dropIndexes(t){return this._dispatch((function(t){return t.col.dropIndexes()}))({callback:t},"dropIndexes")}find(t,e,n){if("function"==typeof e&&(n=e,e={}),(e||{}).rawCursor)return delete e.rawCursor,this._dispatch((function(t){return Promise.resolve(t.col.find(t.query,t.options))}))({options:e,query:t,callback:n},"find");var o=this._dispatch((function(t){var i=t.col.find(t.query,t.options);if(!(e||{}).stream&&!o.eachListener)return i.toArray();function r(){i.close()}function s(){i.rewind()}return"function"==typeof(e||{}).stream&&(o.eachListener=(e||{}).stream),new Promise((async function(t,e){try{for(;await i.hasNext();){const t=await i.next();await o.eachListener(t,{close:r,rewind:s})}}catch(t){n&&n(t),e(t)}t()}))}))({options:e,query:t,callback:n},"find");return o.each=function(t){return o.eachListener=t,o},o}findOne(t,e,n){if("function"==typeof e&&(n=e,e={}),"string"==typeof e){const t=new Error("DEPRECATED (findOne.projection): findOne should pass an options object instead of a projection string");console.warn(t),e={projection:e}}return"string"==typeof(e=e||{}).projection&&(e.projection=e.projection.split(" ").reduce(((t,e)=>("-"===e[0]?t[e.slice(1)]=0:t[e]=1,t)),{})),this._dispatch((function(t){return t.col.find(t.query,t.options).limit(1).toArray().then((function(t){return t&&t[0]||null}))}))({options:e,query:t,callback:n},"findOne")}findOneAndDelete(t,e,n){return"function"==typeof e&&(n=e,e={}),this._dispatch((function(t){return t.col.findOneAndDelete(t.query,t.options).then((function(t){return t&&void 0!==t.value?t.value:t.ok&&t.lastErrorObject&&0===t.lastErrorObject.n?null:t}))}))({options:e,query:t,callback:n},"findOneAndDelete")}findOneAndUpdate(t,e,n,o){return"function"==typeof n&&(o=n,n={}),this._dispatch((function(t){var e="findOneAndUpdate";return void 0===(t.options||{}).returnDocument&&(t.options.returnDocument="after"),t.options.replaceOne|t.options.replace&&(e="findOneAndReplace"),t.col[e](t.query,t.update,t.options).then((function(t){return t&&void 0!==t.value?t.value:t.ok&&t.lastErrorObject&&0===t.lastErrorObject.n?null:t}))}))({options:n,query:t,update:e,callback:o},"findOneAndUpdate")}indexes(t){return this._dispatch((function(t){return t.col.indexInformation()}))({callback:t},"indexes")}insert(t,e,n){return"function"==typeof e&&(n=e,e={}),this._dispatch((function(t){var e=Array.isArray(t.data);if(e&&0===t.data.length)return Promise.resolve([]);return(e?t.col.insertMany(t.data,t.options):t.col.insertOne(t.data,t.options)).then((function(n){if(e)return t.data.map(((t,e)=>({_id:n.insertedIds[e],...t})));return{_id:n.insertedId,...t.data}}))}))({data:t,options:e,callback:n},"insert")}remove(t,e,n){return"function"==typeof e&&(n=e,e={}),this._dispatch((function(t){var e=t.options||{},n=e.single||!1===e.multi?"deleteOne":"deleteMany";return t.col[n](t.query,t.options)}))({query:t,options:e,callback:n},"remove")}update(t,e,n,o){return"function"==typeof n&&(o=n,n={}),this._dispatch((function(t){var e=t.options||{},n=e.multi||!1===e.single?"updateMany":"updateOne";if(e.replace||e.replaceOne){if(e.multi||!1===e.single)throw new Error("The `replace` option is only available for single updates.");n="replaceOne"}return t.col[n](t.query,t.update,t.options)}))({update:e,query:t,options:n,callback:o},"update")}index(...t){return this.createIndex(...t)}}function l(t){return null==t?s.default.ObjectId():"string"==typeof t?s.default.ObjectId.createFromHexString(t):t}var d={id:l,cast:function t(e){return Array.isArray(e)?e.map(t):(e&&"object"==typeof e&&Object.keys(e).forEach((function(n){"_id"===n&&e._id?e._id.$in?e._id.$in=e._id.$in.map(l):e._id.$nin?e._id.$nin=e._id.$nin.map(l):e._id.$ne?e._id.$ne=l(e._id.$ne):e._id=l(e._id):e[n]=t(e[n])})),e)}};function p(t,e){if(!Array.isArray(t)&&"object"==typeof t)return t;for(var n={},o=0,i=(t="string"==typeof t?t.split(" "):t||[]).length;o<i;o++)"-"===t[o][0]?n[t[o].substr(1)]=e:n[t[o]]=1;return n}global.TextEncoder=t.TextEncoder,global.TextDecoder=t.TextDecoder;var f,h=c.default("monk:manager"),m=s.default.MongoClient,y="closed",g="opening",_="open",b={castIds:!0,middlewares:[function(t){return function(t){return function(e,n){return e.query?("string"!=typeof e.query&&"function"!=typeof e.query.toHexString||(e.query={_id:e.query}),t(e,n)):t(e,n)}}},function(t){return function(e){return function(n,o){var i=t.collection;if("string"==typeof n.options||Array.isArray(n.options))return n.options={fields:p(n.options)},e(n,o);for(var r in n.options=n.options||{},n.options.fields&&(n.options.fields=p(n.options.fields,0)),n.options.sort&&(n.options.sort=p(n.options.sort,-1)),i.options)r in n.options||(n.options[r]=i.options[r]);return e(n,o)}}},(f=["operations","query","data","update"],function(t){return function(e){return function(n,o){return!1===(n.options||{}).castIds?(delete n.options.castIds,e(n,o)):((n.options||{}).castIds&&delete n.options.castIds,f.forEach((function(e){n[e]&&(n[e]=t.monkInstance.cast(n[e]))})),e(n,o))}}}),function(t){return function(t){return function(e,n){if(!e.fields)return t(e,n);if(!Array.isArray(e.fields)&&"object"==typeof e.fields)return t(e,n);var o={};e.fields="string"==typeof e.fields?e.fields.split(" "):e.fields||[];for(var i=0,r=e.fields.length;i<r;i++)o[e.fields[i]]=1;return e.fields=o,t(e,n)}}},function(t){return function(t){return function(e,n){return t(e,n).then((o=e.callback,function(t){return o&&"function"==typeof o&&setTimeout(o,0,null,t),t})).catch(function(t){return function(e){if(!t||"function"!=typeof t)throw e;setTimeout(t,0,e)}}(e.callback));var o}}},function(t){return function(e){return function(n,o){return t.monkInstance.executeWhenOpened().then((function(e){return e.collection(t.collection.name)})).then((function(t){return n.col=t,e(n,o)}))}}}]};class w extends i.EventEmitter{constructor(t,e,n){if(super(),!t)throw Error("No connection URI provided.");if("function"==typeof e&&(n=e,e={}),(e=e||{}).hasOwnProperty("useNewUrlParser")||(e.useNewUrlParser=!0),e.hasOwnProperty("useUnifiedTopology")||(e.useUnifiedTopology=!0),this._collectionOptions=a.default({},b,e.collectionOptions||{}),this._collectionOptions.middlewares=this._collectionOptions.middlewares.slice(0),delete e.collectionOptions,Array.isArray(t)){if(!e.database)for(var o=0,i=t.length;o<i;o++)e.database||(e.database=t[o].replace(/([^/])+\/?/,"")),t[o]=t[o].replace(/\/.*/,"");t=t.join(",")+"/"+e.database,h('repl set connection "%j" to database "%s"',t,e.database)}"string"==typeof t&&(/^mongodb(\+srv)?:\/\//.test(t)||(t="mongodb://"+t)),this._state=g,this.emit("opening"),this._queue=[],this.on("open",(t=>{h("connection opened"),h("emptying queries queue (%s to go)",this._queue.length),this._queue.forEach((function(e){e(t)})),this._queue=[]})),this._connectionURI=t,this._connectionOptions=e,this.open(t,e,n&&function(t){n(t,this)}.bind(this)),this.helper={id:s.default.ObjectId},this.collections={}}then(t){return new Promise(function(t,e){this.once("open",t),this.once("error-opening",e)}.bind(this)).then(t.bind(null,this))}catch(t){return new Promise(function(t){this.once("error-opening",t)}.bind(this)).then(t.bind(null))}async listCollections(t){const e=await this.executeWhenOpened();return(await e.listCollections(t).toArray()).map((t=>this.get(t).name))}create(t,e,n){return this.executeWhenOpened().then((function(n){n.createCollection(t,e)})).catch((function(t){this.emit("error",t)})),this.get(t,n)}async open(t,e,n){let o;try{const n=await m.connect(t,e);this._state=_,this._client=n,this._db=n.db(),this.on("reconnect",(()=>{this._state=_})),this.emit("open",this._db),this.emit("reconnect",this._db)}catch(t){this._state=y,this.emit("error-opening",t),this.emit("error",t),o=t}if(n){const t=new Error("DEPRECATED (manager.open) call back function is deprecated, please use the promise interface");console.warn(t),n(o,this)}}executeWhenOpened(){return new Promise((t=>{switch(this._state){case _:return t(this._db);case g:this._queue.push(t);break;default:this._queue.push(t),this.open(this._connectionURI,this._connectionOptions)}}))}close(t,e){if("function"==typeof t&&(e=t,t=!1),"function"==typeof e){const t=new Error("DEPRECATED (manager.close) call back function is deprecated, please use the promise interface");console.warn(t)}const n=n=>{this._client.close(t,(()=>{this._state=y,e&&e(),this.emit("close"),n()}))};return new Promise((t=>{switch(this._state){case y:return e&&e(),t();case g:this._queue.push((function(){n(t)}));break;default:n(t)}}))}get(t,e){return!1!==(e||{}).cache&&this.collections[t]||(delete(e||{}).cache,this.collections[t]=new u(this,t,a.default({},this._collectionOptions||{},e||{}))),this.collections[t]}setDefaultCollectionOptions(t){this._collectionOptions=t}addMiddleware(t){this._collectionOptions||(this._collectionOptions={}),this._collectionOptions.middlewares||(this._collectionOptions.middlewares=[]),this._collectionOptions.middlewares.push(t)}col(...t){return this.get(...t)}static oid(...t){return d.id(...t)}oid(...t){return d.id(...t)}static id(...t){return d.id(...t)}id(...t){return d.id(...t)}static cast(...t){return d.cast(...t)}cast(...t){return d.cast(...t)}}const O=function(...t){return new w(...t)};O.id=d.id,O.cast=d.cast;const k=d.id;exports.Collection=u,exports.default=O,exports.helpers=d,exports.id=k,exports.manager=O;
